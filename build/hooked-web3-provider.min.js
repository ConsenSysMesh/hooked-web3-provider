"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),_get=function(t,e,n){for(var r=!0;r;){var o=t,a=e,i=n;s=l=c=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,a);if(void 0!==s){if("value"in s)return s.value;var c=s.get;return void 0===c?void 0:c.call(i)}var l=Object.getPrototypeOf(o);if(null===l)return void 0;t=l,e=a,n=i,r=!0}},factory=function(t){var e=function(e){function n(t){var e=t.host,r=t.transaction_signer;_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,e),this.transaction_signer=r,this.global_nonces={}}return _inherits(n,e),_createClass(n,[{key:"send",value:function(t){var e=t;e instanceof Array||(e=[e]);var r=!0,o=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var c=i.value;if("eth_sendTransaction"==c.method)throw new Error("HookedWeb3Provider does not support synchronous transactions. Please provide a callback.")}}catch(l){o=!0,a=l}finally{try{!r&&s["return"]&&s["return"]()}finally{if(o)throw a}}return _get(Object.getPrototypeOf(n.prototype),"send",this).call(this,t)}},{key:"sendAsync",value:function(t,e){var r=this,o=Object.assign({},this.global_nonces),a=function(){_get(Object.getPrototypeOf(n.prototype),"sendAsync",r).call(r,t,function(t,n){return(t||n.error)&&(this.global_nonces=o),e(t,n)}.bind(r))},i=t;t instanceof Array||(i=[t]),this.rewritePayloads(0,i,{},a)}},{key:"rewritePayloads",value:function(e,n,r,o){var a=this;if(e>=n.length)return o();var i=n[e],s=function(t){return null!=t?o(t):a.rewritePayloads(e+1,n,r,o)};if("eth_sendTransaction"!=i.method)return s();var c=i.params[0],l=c.from;this.transaction_signer.hasAddress(l,function(e,n){if(null!=e||0==n)return s(e);var u=function(e){var n=r[l];null!=n?e(null,n):a.sendAsync({jsonrpc:"2.0",method:"eth_getTransactionCount",params:[l,"pending"],id:(new Date).getTime()},function(n,r){if(null!=n)e(n);else{var o=r.result;e(null,t.toDecimal(o))}})};u(function(e,n){if(null!=e)return o(e);var u=Math.max(n,a.global_nonces[l]||0);c.nonce=t.toHex(u),r[l]=u+1,a.global_nonces[l]=u+1,a.transaction_signer.signTransaction(c,function(t,e){return null!=t?s(t):(i.method="eth_sendRawTransaction",i.params=[e],s())})})})}}]),n}(t.providers.HttpProvider);return e};"undefined"!=typeof module?module.exports=factory(require("web3")):window.HookedWeb3Provider=factory(web3);